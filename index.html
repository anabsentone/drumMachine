<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <!-- <link rel='shortcut icon' href='images/logo.png'> -->
        <!-- <link rel='stylesheet' type='text/css' href='css/html5reset.css'> -->
        
        <!-- Bootstrap 5.3 https://getbootstrap.com/docs/5.3/getting-started/introduction -->
        <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH' crossorigin='anonymous'>
        <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js' integrity='sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz' crossorigin='anonymous'></script>
        
        <script src="http://unpkg.com/tone"></script>
        
        <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Roboto'>
        <title>Drum Machine</title>
        <style>
            body {
                margin: 5px;
                background-color: lightgray;
            }
            
            /* #controls {
                display: inline;
            } */
            
            #BPMInputDiv {
                width: 50vw;
            }
            
            #stopButtonDiv {
                display: none;
            }
        </style>
        
        <script>
            var numBeats = 8;
            function generateBeatgrid() {
                var tableHeaderRow = document.getElementById('beatgrid').getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
                var firstInstrumentRow = document.getElementById('beatgrid').getElementsByTagName('tbody')[0].getElementsByTagName('tr')[0];
                var secondInstrumentRow = document.getElementById('beatgrid').getElementsByTagName('tbody')[0].getElementsByTagName('tr')[1];
                var thirdInstrumentRow = document.getElementById('beatgrid').getElementsByTagName('tbody')[0].getElementsByTagName('tr')[2];
                for (var i = 1; i < numBeats + 1; i++) {
                    var newTh;
                    var newTd;
                    var newInput;
                    var charA;
                    var charB;
                    for (var j = 0; j < 4; j++) {
                        switch (j) {
                            case 0:
                                charA = i;
                                charB = '#';
                                break;
                            case 1:
                                charA = 'E';
                                charB = 'E';
                                break;
                            case 2:
                                charA = '&';
                                charB = '&';
                                break;
                            case 3:
                                charA = 'A';
                                charB = 'A';
                                break;
                        }
                        newTh = document.createElement('th');
                        newTh.setAttribute('scope', 'col');
                        newTh.innerText = charA;
                        tableHeaderRow.appendChild(newTh);
                        
                        for (var k = 0; k < 3; k++) {
                            newTd = document.createElement('td');
                            newInput = document.createElement('input');
                            switch (k) {
                                case 0:
                                    newInput.id = i + charB + 'HInput';
                                    break;
                                case 1:
                                    newInput.id = i + charB + 'SInput';
                                    break;
                                case 2:
                                    newInput.id = i + charB + 'KInput';
                                    break;
                            }
                            newInput.class = 'form-check-input';
                            newInput.type = 'checkbox';
                            newTd.appendChild(newInput);
                            switch (k) {
                                case 0:
                                    firstInstrumentRow.appendChild(newTd);
                                    break;
                                case 1:
                                    secondInstrumentRow.appendChild(newTd);
                                    break;
                                case 2:
                                    thirdInstrumentRow.appendChild(newTd);
                                    break;
                            }
                        }
                    }                    
                }
            }
            
            var now;
            var BPM = 100;
            var increment = (60 / BPM) / 4; // number of seconds between each increment 1-E-&-A
            
            const players = new Tone.Players({
                hihat: 'https://anabsentone.github.io/drumMachine/RD_C_HH_7.wav',
                snare: 'https://anabsentone.github.io/drumMachine/RD_S_P_10.wav',
                kick: 'https://anabsentone.github.io/drumMachine/RD_K_6.wav'
            }).toDestination();
            const hihatSample = new Tone.Player('https://anabsentone.github.io/drumMachine/RD_C_HH_7.wav').toDestination();
            const snareSample = new Tone.Player('https://anabsentone.github.io/drumMachine/RD_S_P_10.wav').toDestination(); // need better snare
            const kickSample = new Tone.Player('https://anabsentone.github.io/drumMachine/RD_K_6.wav').toDestination();
            
            function updateBPM() {
                document.getElementById('BPMInputLabel').innerText = document.getElementById('BPMInput').value + ' BPM';
                
                BPM = document.getElementById('BPMInput').value;
                increment = (60 / BPM) / 4;
                console.log(BPM);
                console.log(increment);
            }
            
            function updateVolume(instrument) {
                switch (instrument) {
                    case 'hihat':
                        document.getElementById('hihatVolumeInputLabel').innerText = document.getElementById('hihatVolumeInput').value;
                        hihatSample.volume.value = document.getElementById('hihatVolumeInput').value;
                        break;
                    case 'snare':
                        document.getElementById('snareVolumeInputLabel').innerText = document.getElementById('snareVolumeInput').value;
                        snareSample.volume.value = document.getElementById('snareVolumeInput').value;
                        break;
                    case 'kick':
                        document.getElementById('kickVolumeInputLabel').innerText = document.getElementById('kickVolumeInput').value;
                        kickSample.volume.value = document.getElementById('kickVolumeInput').value;
                        break;
                }
            }
            
            function play() {
                document.getElementById('playButtonDiv').style.display = 'none';
                document.getElementById('stopButtonDiv').style.display = 'initial';
                document.getElementById('BPMInput').disabled = true;
                
                now = Tone.now();                
                var char;
                var counter = 0;
                for (var i = 1; i < numBeats + 1; i++) {
                    for (var j = 0; j < 4; j++) {
                        switch (j) {
                            case 0:
                                char = '#';
                                break;
                            case 1:
                                char = 'E';
                                break;
                            case 2:
                                char = '&';
                                break;
                            case 3:
                                char = 'A';
                                break;
                        }
                        if (document.getElementById(i + char + 'HInput').checked) {
                            hihatSample.start(now + counter * increment);
                        }
                        if (document.getElementById(i + char + 'SInput').checked) {
                            snareSample.start(now + counter * increment);
                        }
                        if (document.getElementById(i + char + 'KInput').checked) {
                            kickSample.start(now + counter * increment);
                        }
                        counter++;
                    }
                }
            }
            
            function stop() {
                document.getElementById('playButtonDiv').style.display = 'initial';
                document.getElementById('stopButtonDiv').style.display = 'none';
                document.getElementById('BPMInput').disabled = false;
                
                hihatSample.stop();
                snareSample.stop();
                kickSample.stop();
            }
        </script>
    </head>

    <body class='container-fluid' onload='generateBeatgrid();'>
        <div id='controls'>
            <div id='BPMInputDiv'>
                <label id='BPMInputLabel' for='BPMInput' class='form-label'>100 BPM</label>
                <input id='BPMInput' type='range' class='form-range' min='70' max='140' value='100' oninput='updateBPM();'>
            </div>
            <div id='playerControls'>
                <div id='playButtonDiv'>
                    <button id='playButton' class='btn btn-md btn-secondary shadow m-2' onclick='play();'>▶</button>
                </div>
                <div id='stopButtonDiv'>
                    <button id='stopButton' class='btn btn-md btn-secondary shadow m-2' onclick='stop();'>⏹</button>
                </div>
            </div>
        </div>
        <div id='beatgrid'>
            <table class='table'>
                <thead>
                    <tr>
                        <th scope='col'>Instrument</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th scope='row'>
                            Hi-Hat
                            <div id='hihatVolumeInputDiv'>
                                <label id='hihatVolumeInputLabel' for='hihatVolumeInput' class='form-label'>0</label>
                                <input id='hihatVolumeInput' type='range' class='form-range' min='-10' max='10' value='0' oninput='updateVolume("hihat");'>
                            </div>
                        </th>
                    </tr>
                    <tr>
                        <th scope='row'>
                            Snare
                            <div id='snareVolumeInputDiv'>
                                <label id='snareVolumeInputLabel' for='snareVolumeInput' class='form-label'>0</label>
                                <input id='snareVolumeInput' type='range' class='form-range' min='-10' max='10' value='0' oninput='updateVolume("snare");'>
                            </div>
                        </th>
                    </tr>
                    <tr>
                        <th scope='row'>
                            Kick
                            <label id='kickVolumeInputLabel' for='kickVolumeInput' class='form-label'>0</label>
                            <input id='kickVolumeInput' type='range' class='form-range' min='-10' max='10' value='0' oninput='updateVolume("kick");'>
                        </th>
                    </tr>
                </tbody>
            </table>
        </div>
    </body>
</html>